# 创建和管理设备模板

设备模板是设备接入的桥梁，由规约与设备测点映射关系两部分组成。对于一个实际的设备，其设备测点的名称多数情况下是客户化的，系统无法直接识别此客户化的名称。因此，一方面，需通过映射，将客户化的实际测点与标准化的设备模型领域点对应起来。另一方面，需配置设备接入的规约。

设备模板的创建步骤：

![](media/image035.png)

*图：设备模板管理三部曲*

设备模板的创建主要有2种方式：
- 全新创建。
- 基于原有设备模板复制创建，而后基于此模板做修改。该方式适用于两种设备模板近似的场景，通过复制的方式获取副本而后稍作修改得到新模板，可减少实施的工作量。

## 全新创建设备模板

1. 在EnOS控制台导航栏中点击**设备Edge接入 > 设备模板**。
2. 点击 **新建设备模板**。在弹出的对话框填写设备基本信息及选择设备模型，点击 **保存**。
3. 点击新建好的模板记录后的编辑按钮![](media/image037.png)，进入模板详情页面。模板详情页面包括最上方的基本信息编辑栏，中部的点表上传栏，和下部的映射关系配置栏，如下图所示：

  ![](media/image039.png)

  *图：设备模板编辑页面——以风机为例*

以下信息描述如何配置设备模板。

### 配置基本信息

在**基本信息**部分，填写设备基本信息，选择规约类型和具体规约。

![](media/image040.png)

*图：模板基本信息编辑*

- 你可以查看和选择当前EnOS Edge支持的通用规约以及各规约关联的模板。点击规约详情链接，在弹出的对话框中，光标置于![](media/image041.png)图标处，可查看各规约的描述信息，以确定合适的规约。
- 若没有找到合适规约，可联系平台系统管理员。你也可以重新开发规约并上传到规约管理中心，并进行编辑，更新等操作。有关开发新规约，参考[创建规约](creating_protocol)。

![](media/image042.png)

*图：规约详情页*

### 上传点表

在**电表上传**部分，你需要编辑两个配置文件：
- `config.sys`文件是与通信规约相关的参数配置文件
- `point.csv`表是设备实际的测点表。

下载`config.sys`模板和`point.csv`模板，填写完成后上传。

*注意：point.csv点表需为UTF-8 BOM格式，格式不正确可能导致显示出错等问题；若point.csv表里的"别名"列有值，在进行更新点表操作，即上传一份新的点表时，需首先上传一份空的点表覆盖原有的，再上传实际的点表，以免出错。*

上一步通信规约选择完成后，这里上传`point.csv`表若成功，则会在下方的预览栏中看到`point.csv`表中的测点信息，如下图所示：

![](media/image043.png)

*图：规约选择及点表导入*


### 选择模型与配置映射关系

在**模型选择与映射**部分，你可以通过配置映射关系将客制化的实际点与标准化的设备模型点对应起来。主要步骤为：
1. 选择采用的标准设备模型。
2. 找到需配置映射的测点记录，点击标准模型点右侧的![](media/image045.png)按钮。

  ![](media/image044.png)

  *图：标准模型选择及映射关系配置*

3. 在弹出的对话框中选择其所要对应的实际采集点，如下图所示：

  ![](media/image046.png)

  *图：映射关系配置*

  在弹出的对话框中，可在搜索栏中输入采集点点名的关键词，系统会过滤出包含关键词的测点供用户选择，如下图所示。

  - 对于简单一一对应的映射关系，直接勾选相应的测点即可
  - 对于复杂的映射关系，可点击添加公式按钮，配置映射公式，如下图所示：

    ![](media/image047.png)

    *图：添加公式按钮*

    ![](media/image048.png)

    *图：选择公式*

    以"SUM"相加公式为例，公式算法栏中选择"SUM"，选取采集点框内按相加顺序点击相应点后的![](media/image049.png)，即可完成添加，如下图所示，添加的公式为"ai.4999+ai.5001"，顺序和点击顺序一致：

    ![](media/image050.png)

    *图：SUM公式添加说明*

  **说明**：添加顺序在某些公式中很重要，如在cross
  product操作中，公式算法栏选择"cross
  product"，按顺序选择四个点，添加的公式为"(ai.4999\*ai.5000+ai.5009\*ai.5010)"，图中操作数一栏类似于系数，为0则不操作，例如下图中操作数为0.01，则最后添加的公式为"(ai.4999\*ai.5000+ai.5009\*ai.5010)\*0.01"。

  ![](media/image051.png)

  *图：点选择顺序与操作数*

### 批量配置映射关系

你可以通过以下步骤实现一次性完成所有映射关系配置：

1. 在**模型选择与映射**栏，点击**导出**按钮，下载领域点映射表。
2. 编辑表格以完成所有点的映射关系后，再点击**导入**按钮上传映射表。

  ![](media/image052.png)

  *图：批量配置映射关系*

  ![](media/image053.png)

  *图：映射关系表*

  *注意：在映射关系表的mapping列下填写采集点的点号即可，mdesp一列指采集点的描述，不需要填写。在成功上传映射关系表后，再下载领域点列表，即可下载包含了映射关系的映射关系表，此时的表中已包含了采集点的描述（因描述可以从驱动配置文件point.csv表中自动获取）。*

  完成映射关系配置后，各标准模型点对应的采集点点号及描述关系可在页面中看到，如下图所示，点击保存后完成设备模板的编辑操作。

  **说明**：

  - 并非所有设备模型点都需要配置映射关系，具体根据各领域的应用需求而定；

  - 需要添加公式映射的点必须通过手动添加的方式来配置，无法直接使用导入/导出来操作；

  - 已完成映射的表点击 **导出** 后，对于那些通过配公式映射的点，不会出现在导出后的csv文件中，但是在后台是存在的。

## 通过复制创建设备模板

在模板管理菜单页可查看本客户下所有设备模板，当某个新设备的设备模板与已有设备模板类似时，可通过复制创建的方式，减少实施工作量。

找到所需要复制的原始设备模板，点击复制按钮，填写新设备模板的名称后，即可完成创建。

**注意**：设备模板名称必须唯一，不可重名，否则会报错。

此后，用户只需要对此设备模板做相应的修改以满足需要即可，如下图所示：

![](media/image055.png)

*图：复制设备模板*

![](media/image056.png)

*图：填写新设备模板的名称*

![](media/image057.png)

*图：完成设备模板复制*

## 修改和删除设备模板

在**模板管理**页：
- 点击模板**编辑**按钮，进入目标设备模板详情页面即可修改模板。
- 点击模板**删除**按钮，即可直接将模板删除。

*注意：对已经被使用的模板的修改和删除操作需要谨慎，因为将会影响到所有使用到该模板的设备实例。*
