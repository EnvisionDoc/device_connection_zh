# 缓存命令下发

EnOS用户可以通过`setMeasurePoint`和`invokeService`向设备下发命令，以设置测点、调用服务。

在设备与云端连接断开，或在低功耗设备因长期休眠无法及时获取及执行EnOS下发的命令的场景下，EnOS通过云端缓存命令功能缓存命令，待设备再次上线时下发命令，并可对下发的命令进行状态跟踪。

调用API下发命令时，如果在API请求中的`pendingTtl`参数中设置了0-172800秒中的非零整数，则意味着该命令是一个可被缓存的命令，`pendingTtl`参数的值即为该命令的有效期。

## 流程

发送缓存的命令前，云端会先判断设备是否在线：
- 如果设备在线则直接进行下发，并获得返回的响应信息，同即时下发场景。
- 如果设备处于离线状态，则云端首先将该条命令加入到此设备的缓存下发队列中，缓存队列是一个有序的队列，等待设备重新与云端建立连接后，云端对缓存的命令按顺序进行下发。

## 规则

EnOS会按照下列规则：

- **缓存有序下发**：设备处理并返回上一条命令的响应信息后，云端才会发送下一条缓存命令，上一条命令的处理结果包括：发送成功（设备接收命令并正常响应）和响应超时（云端已经发送了命令但是设备没有及时响应）；

- **命令优先级**：缓存命令无优先级。无论设备是否在线，在缓存命令尚未处理完，而应用侧又重新发送了一条新命令的情况下，无论新命令是即时下发的还是缓存下发的，都仍会加入到队列中等待按照顺序下发。如果要优先发送新命令，应用侧应当调用`cancelOneCommand`和`cancelAllCommand` API对缓存的命令进行撤销操作，才可下发新的命令。也就是说缓存队列中，同时存在缓存命令和立即下发的命令，则所有命令会按顺序下发。如果此时设备下线了，则即时下发的命令将自动失败；

- **命令有效期**：缓存命令具有有效期，有效期可以由应用侧进行指定，默认值为0s，即应用不指定的话即作为即时命令下发，有效期最大值不超过48小时（172800s），对于超过有效期的缓存命令，云端需要从缓存队列中自动清除，并将状态置为“已超期”；

- **单个设备最多可缓存命令**：50条；

- **历史命令相关信息最长存储时长**：7天；

## 设备端开发

设备可以在响应信息中带上自定义的业务描述信息以说明命令执行的状态，响应数据格式如下,`message`为描述字段。
```json
{
    "id": "123",
    "code": 200,
    “message”：“该命令已成功执行”               
    "data": {                                
               "outputdata1":234,
               "outputdata2":"xyz"
              }
}
```

## 相关文档

有关API的使用，在EnOS控制台点击EnOS API > API 文档进行查看。

有关如何在控制台查看被缓存的数据的状态，参见[查看下发的数据的状态](../../howto/device/manage/viewing_command_status)。


